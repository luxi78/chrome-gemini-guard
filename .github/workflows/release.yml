name: "Release"

on:
  push:
    # 只要推送到包含 v 的标签（例如 git tag v1.0.0 && git push origin v1.0.0），就会自动触发打包发布
    tags:
      - 'v*'
  # 允许在 GitHub Actions 网页端手动点击按钮触发
  workflow_dispatch:

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "windows-latest"
            args: ""
            rust_target: "x86_64-pc-windows-msvc"
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
            rust_target: "aarch64-apple-darwin"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
            rust_target: "x86_64-apple-darwin"

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Sync version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ -z "$VERSION" || "$VERSION" == "master" || "$VERSION" == "main" ]]; then
            echo "Not a tag release, skipping version sync"
          else
            echo "Syncing version $VERSION to files..."
            bun -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '$VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
            bun -e "const fs = require('fs'); const tauri = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8')); tauri.version = '$VERSION'; fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(tauri, null, 2) + '\n');"
            bun -e "const fs = require('fs'); let cargo = fs.readFileSync('src-tauri/Cargo.toml', 'utf8'); cargo = cargo.replace(/version = \".*?\"/, 'version = \"' + '$VERSION' + '\"'); fs.writeFileSync('src-tauri/Cargo.toml', cargo);"
          fi

      - name: Install frontend dependencies
        run: bun install

      - name: Build and Publish Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__
          releaseName: "Chrome Gemini Guard v__VERSION__"
          releaseBody: "请在下方 Assets 中下载对应系统版本的程序。Windows 用户可以直接下载 `.exe` 单文件绿色版直接运行。"
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
          includeRelease: true

      - name: Replace installers with portable exe (Windows only)
        if: matrix.platform == 'windows-latest'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          $version = (Get-Content src-tauri/tauri.conf.json | ConvertFrom-Json).version
          $tag = "v$version"

          # 找到所有 setup.exe / .msi 的 asset id，通过 API 删除它们
          $assets = gh api repos/$env:REPO/releases/tags/$tag --jq '.assets[] | select(.name | test("setup\\.exe$|\\.msi$")) | .id'
          foreach ($id in ($assets -split "`n" | Where-Object { $_ -ne "" })) {
            gh api -X DELETE repos/$env:REPO/releases/assets/$id
            Write-Host "Deleted asset id: $id"
          }

          # 上传绿色单文件 exe
          $dest = "chrome-gemini-guard_${version}_x64.exe"
          Copy-Item src-tauri/target/release/chrome-gemini-guard.exe $dest
          gh release upload $tag $dest --clobber
          Write-Host "Uploaded portable exe: $dest"
